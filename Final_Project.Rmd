---
title: "Final Project"
author: "Bridget Silha"
date: "12/14/2019"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r, echo = FALSE}
require(tidyverse)
require(caret) # for machine learning
require(recipes) # For preprocessing your data
require(rattle) # For nice tree plots
require(lubridate) # For rounding dtaes

doMC::registerDoMC()
#tinytex::install_tinytex()
```


```{r, warning=FALSE}
## -------------------------------------- Reading in data --------------------------------------------##

#Read CVS data in
total_fec_committee_party_and_pac <- read_csv("committees.csv")
##DATA DESCRIPTION FOR COMMITTEE TYPE: https://www.fec.gov/campaign-finance-data/committee-type-code-descriptions/ 

pac_financial_info_2018 <- read_csv("committee_summary_2018.csv")
##DATA DESCRIPTION: https://www.fec.gov/campaign-finance-data/committee-summary-file-description/ 
```

# Introduction

- What is the aim of this project? 
  - Summarize the problem
  - State your goals
– What do you do in this report?
  - offer a roadmap of the project
  

# Problem Statement and Background

– Give a clear and complete statement of the problem and/or aim of your analysis.
– Include a brief summary of any related work that has tried to tackle a project similar to
yours (i.e. a light literature review)

```{r}
## ----------------------------------- Cleaning data: Combining CVS and cleaning dataset ---------------------------------##

#Bind 2018 committee information and financial information together
new_data <- right_join(total_fec_committee_party_and_pac, pac_financial_info_2018, by=c("committee_id" = "CMTE_ID"), c("name" = "CMTE_NM"))

#Cut down variables
new_data <- new_data %>% 
  select (-Link_Image, -CMTE_ST1:-CMTE_CITY, -CMTE_ZIP:-CAND_ID, -INDV_CONTB:-OTH_CMTE_CONTB, -TRANF_FROM_OTHER_AUTH_CMTE:-OTHER_RECEIPTS, -TRANF_TO_OTHER_AUTH_CMTE:-OTHER_DISB, -NET_CONTB:-TTL_COMMUNICATION_COST, -COH_BOY, -COH_COY, -name, -cycles, -treasurer_name, -filing_frequency:-affiliated_committee_name, -party_full, -candidate_ids, -FEC_ELECTION_YR, -CMTE_TP)

#Committee name and commmitte id as first variables
new_data <- new_data %>% 
  select (CMTE_NM, committee_id, everything())

skimr::skim(new_data)

#Filter for committee type -- only PACs
new_data <- new_data %>% 
  filter(committee_type == "N" | committee_type == "O" | committee_type == "Q" | committee_type == "V" | committee_type == "W")

#Filter out terminated committees
new_data <- new_data %>% 
  filter(CMTE_FILING_FREQ == "M" | CMTE_FILING_FREQ == "Q")

#check to see that committee_ids are unique for all observations
skimr::skim(new_data)

new_data %>% glimpse()

```

```{r}
## ----------------------------------- Cleaning data: Changing variables to Date using lubridate ---------------------------------##

new_data$first_file_date <- as.Date(new_data$first_file_date, format = "%m/%d/%y")
new_data$last_f1_date <- as.Date(new_data$last_f1_date, format = "%m/%d/%y")
new_data$last_file_date <- as.Date(new_data$last_file_date, format = "%m/%d/%y")

str(new_data)
```


```{r}
## ----------------------------------- Cleaning data: Adding new SuperPAC_yes response variable ---------------------------------##


# Add new variable to dataset
# if Superpac, Then SuperPAC_yes = 1

new_data <- new_data %>% 
  mutate(SuperPAC_yes = recode(committee_type, "O" = 1, "N" = 0, "V" = 0, "W" = 0, "Q" = 0, .default = 0))

skimr::skim(new_data)

```

```{r}
## ------------------------- Code for Party ---------------------##

#new_data <- new_data %>% 
  #mutate(party = recode(party, REP = "REP", DEM = "DEM", .default = "NONE")) %>% 
  #mutate(party = ifelse(party == "DEM" | party == "REP", party, "NONE"))

#skimr::skim(new_data)

```

# Data

– Where does the data come from?
– What is the unit of observation?
– What are the variables of interest?
– What steps did you take to wrangle the data?

```{r}
## --------------------- Splitting data into training and test datasets -------------------##

range(new_data$first_file_date)
range(new_data$last_file_date)

#split into training and test data
index = createDataPartition(new_data$SuperPAC_yes,p=.8,list=F) 
train_data = new_data[index,] # Use 80% of the data as training data 
test_data = new_data[-index,] # holdout 20% as test data 

# Proporation in the training data 
round(nrow(train_data)/nrow(new_data),3)

# Proporation in the test data 
round(nrow(test_data)/nrow(new_data),3)

#number of observations in training data
dim(train_data)
dim(test_data)

```


```{r}
## --------------------- Data Visualization: categorical variables -------------------##

skimr::skim(train_data)

#Visualize distribution of categorical variables
train_data %>% 
  select(CMTE_DSGN, CMTE_FILING_FREQ, committee_type, ORG_TP) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  geom_bar() +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3)

train_data %>% 
  select(committee_type_full,) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  geom_bar() +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3) + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

# Analysis 

– Describe the methods/tools you explored in your project.
– Outline in detail our entire analysis.
  - Justify the tools/methods that you used.
  - Assume the reader is smart but doesn’t know R/Machine Learning well. That is, be
crystal clear about what you’re doing and why.

## Conlusions:
- There's good, random distribution of some variables such as ORG_TP and CMTE_FILING_FREQ
- There are many multiple errors in the party_full variable where human error might have contributed to similar entries (e.g. "None", "Unknown", "NA")




```{r, echo = FALSE}
## ------------------------- Data Visualization: date variables ---------------------##

#Visualize distribution of date variables
train_data %>% 
  select(first_file_date) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  stat_count(width = 1) +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3) +
  coord_flip()

#peak around late 2019
train_data %>% 
  select(last_f1_date) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  stat_count(width = 1) +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3) +
  coord_flip()

train_data %>% 
  select(last_file_date) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  stat_count(width = 1) +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3) +
  coord_flip()
```

## Conclusions:
- There's a peak around late 2019 for last_f1_date
- last_file_date is consistant with committee filing frequency
- There's a peak around 2008 for times when committees first filed with the FEC



```{r}
## ------------------------- Data Visualization: More in-depth ---------------------##

# Load
require ("RColorBrewer")

#Coverage over states vs. initial filing date grouped by committee type
new_data %>% 
  ggplot(aes(first_file_date, CMTE_ST, color = factor(committee_type))) +
  geom_point(show.legend = T) +
  geom_vline(xintercept = as.numeric(as.Date("2010-01-21"))) +
  #Line to show when Citizens United became official
  scale_fill_discrete(name="PAC Type",
                         breaks=c("O", "N", "Q", "V", "W"),
                         labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  scale_colour_manual(name="PAC Type",
                      breaks=c("N", "O", "Q", "V", "W"), 
                      values = c((brewer.pal(5,"Set1"))),
                      labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  ggtitle("PAC Filing Over Time by State and PAC Type") +
  xlab ("First File Date") +
  ylab ("State of Registration")

```



```{r}
## -------------------------------- Pre-Process the Data: Round Dates ----------------------------##

#Round date variables to nearest month/year
train_data1 <- train_data %>% 
  mutate (first_file_date = round_date(first_file_date, unit = "month")) %>% 
  mutate (last_f1_date = round_date(last_f1_date, unit = "month")) %>% 
  mutate (last_file_date = round_date(last_file_date, unit = "month"))

test_data1 <- test_data %>% 
  mutate (first_file_date = round_date(first_file_date, unit = "month")) %>% 
  mutate (last_f1_date = round_date(last_f1_date, unit = "month")) %>% 
  mutate (last_file_date = round_date(last_file_date, unit = "month"))

#Visualize 
train_data1 %>% 
  select(first_file_date) %>% 
  gather(var,val) %>% 
  ggplot(aes(val)) +
  stat_count(width = 10) +
  scale_y_log10() +
  facet_wrap(~var,scales="free",ncol=3) +
  coord_flip()

#PAC Filing over Time by PAC Type
train_data1 %>% 
  ggplot(aes(first_file_date, color = committee_type)) +
  geom_bar() +
  stat_count(width = 10) +
  scale_fill_discrete(name="PAC Type",
                         breaks=c("N", "O", "Q", "V", "W"),
                         labels = c("PAC - Nonqualified", "Independent expenditure-only (Super PACs)", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  scale_colour_manual(name="PAC Type",
                      breaks=c("N", "O", "Q", "V", "W"), 
                      values = c((brewer.pal(5,"Set1"))),
                      labels = c("PAC - Nonqualified", "Independent expenditure-only (Super PACs)" , "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  xlab("Date of First Filing with FEC") +
  ylab("Number of PACs") +
  ggtitle("PAC Filing Over Time by PAC Type") +
  geom_vline(xintercept = as.numeric(as.Date("2010-01-21"))) +
  ggthemes::theme_tufte()



```


## Conclusions:
- Many of the usual suspects of swing states and power states (i.e. VA, DC, NY, CA) have the most PACs but most of them are made up of PAC-qualified, not SuperPACs
- States do not differ a lot when it comes to total disbursements/total contributions that PACs raise/spend
- It is obvious that PAC-Qualified is the committee type that most often spends and receives the most in each state
- Since Citizens United case, the "first filing date" of SuperPACs and PAC - Nonqualified committees have increased exponentially
- The Citizens United case seems to indicate the start of the majority of "first filing" dates for SuperPACs

```{r, echo = FALSE}
## -------------------------------- Pre-Process the Data: Log money variables ----------------------------##
#Convert TTL_CONTB, TTL_RECEIPTS, TTL_DISB to log

convert_TTL_CONTB <- . %>% mutate(TTL_CONTB = log(TTL_CONTB+1))
convert_TTL_RECEIPTS <- . %>% mutate(TTL_RECEIPTS = log(TTL_RECEIPTS+1))
convert_TTL_DISB <- . %>% mutate(TTL_DISB = log(TTL_DISB+1))

#apply function to both training and test databases

train_data2 <- train_data1 %>%
  convert_TTL_CONTB() %>% 
  convert_TTL_RECEIPTS() %>% 
  convert_TTL_DISB()

test_data2 <- test_data1 %>% 
  convert_TTL_CONTB() %>% 
  convert_TTL_RECEIPTS() %>% 
  convert_TTL_DISB()

#Visualize
train_data2 %>% 
  ggplot(aes(TTL_CONTB)) +
  geom_histogram(binwidth = 1)

train_data2 %>% 
  ggplot(aes(TTL_DISB)) +
  geom_histogram(binwidth = 1)

train_data2 %>% 
  ggplot(aes(TTL_RECEIPTS)) +
  geom_histogram(binwidth = 1)


```

```{r, echo = FALSE}
## -------------------------------- Pre-Process the Data: Visualize log(money) variables ----------------------------##
#Mapped STATE vs. contributions
contb <- train_data2 %>% 
  ggplot(aes(TTL_CONTB, CMTE_ST, color = factor(committee_type))) +
    scale_fill_discrete(name="PAC Type",
                         breaks=c("O", "N", "Q", "V", "W"),
                         labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  scale_colour_manual(name="PAC Type",
                      breaks=c("N", "O", "Q", "V", "W"), 
                      values = c((brewer.pal(5,"Set1"))),
                      labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  geom_jitter(show.legend = T) +
  ggthemes::theme_tufte()

contb


#Mapped STATE vs. expenditures
disb <- train_data2 %>% 
  ggplot(aes(TTL_DISB, CMTE_ST, color = factor(committee_type))) +
    scale_fill_discrete(name="PAC Type",
                         breaks=c("O", "N", "Q", "V", "W"),
                         labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  scale_colour_manual(name="PAC Type",
                      breaks=c("N", "O", "Q", "V", "W"), 
                      values = c((brewer.pal(5,"Set1"))),
                      labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  geom_jitter(show.legend = T) +
  ggthemes::theme_tufte()

disb


#Mapped STATE vs. expenditures
receipt <- train_data2 %>% 
  ggplot(aes(TTL_RECEIPTS, CMTE_ST, color = factor(committee_type))) +
    scale_fill_discrete(name="PAC Type",
                         breaks=c("O", "N", "Q", "V", "W"),
                         labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  scale_colour_manual(name="PAC Type",
                      breaks=c("N", "O", "Q", "V", "W"), 
                      values = c((brewer.pal(5,"Set1"))),
                      labels = c("Independent expenditure-only (Super PACs)", "PAC - Nonqualified", "PAC - Qualified", "PAC with non-contribution account - Nonqualified", "PAC with non-contribution account - Qualified")) +
  geom_jitter(show.legend = T) +
  ggthemes::theme_tufte()

receipt

```

## Conclusions:
- 

```{r, echo = FALSE}
## -------------------------------- Pre-Process the Data: Create recipe and apply to test and training data ----------------------------##


###------------------------------------MY ORIGINAL ATTEMPT ------------------------------------- ####

### Turn ORG_TP and party into factors
#train_data2$ORG_TP <- as.factor (train_data2$ORG_TP)
#train_data2$party <- as.factor (train_data2$party)

###Create recipe

#rcp <-
  #recipe(SuperPAC_yes ~ party + first_file_date + CMTE_DSGN + CMTE_FILING_FREQ + CMTE_ST + TTL_CONTB + TTL_RECEIPTS + TTL_DISB + ORG_TP, train_data2) %>%
  #step_dummy(all_nominal()) %>% 
    #step_range(all_numeric()) %>% 
  #prep()

#rm(rcp)

```

```{r, echo = FALSE}
###### ----------------------------- NATHAN'S FIX ---------------------------------######

# RECODE PARTY
train_data2 <- train_data2 %>% 
  mutate(party = ifelse(party == "DEM" | party == "REP" , party, "NONE"),
         party = ifelse(is.na(party), "NONE", party))

# RECODE ORG_TP
train_data2 <- train_data2 %>% 
    mutate(ORG_TP = ifelse(ORG_TP == "C" | ORG_TP == "T" | ORG_TP == "M", ORG_TP, "NONE"),
         ORG_TP = ifelse(is.na(ORG_TP), "NONE", ORG_TP))

# CONVERT ALL CHARACTERS TO FACTOR
train_data2 <- train_data2 %>% mutate_if(is.character, as.factor)

# CONVERT RESPONSE VARIABLE TO FACTOR
train_data2$SuperPAC_yes <- as.factor(train_data2$SuperPAC_yes)

# CHECK THAT THIS ALL WORKED
str(train_data2)

# CREATE RECIPE
rcp <-
  recipe(
    SuperPAC_yes ~ party + first_file_date + last_file_date + CMTE_DSGN + CMTE_FILING_FREQ + CMTE_ST + TTL_CONTB + TTL_RECEIPTS + TTL_DISB + ORG_TP,
    train_data2
  ) %>%
  step_dummy(party, CMTE_DSGN, CMTE_FILING_FREQ, CMTE_ST, ORG_TP, -all_outcomes()) %>%
  step_knnimpute(TTL_CONTB, TTL_RECEIPTS, TTL_DISB, -first_file_date, -last_file_date) %>% 
  prep()
    
# APPLY RECIPE TO BOTH TRAINING AND TEST DATASETS
train_data_processed <- bake(rcp,train_data2)
test_data_processed <- bake(rcp,test_data2) 

# CONVERT RESPONSE VARIABLE TO FACTOR 
train_data_processed$SuperPAC_yes <- as.factor(train_data_processed$SuperPAC_yes)

# CHECK THAT THIS ALL WORKED
skimr::skim(train_data_processed)
str(train_data_processed)

```

```{r}
## -------------------------------- Cross-Validation --------------------------------##

# set a seed for replication purposes 
set.seed(1988)

# Partition the data into 5 equal folds
folds <- createFolds(train_data_processed$SuperPAC_yes, k = 5) 

sapply(folds,length)

#Validation conditions
control_conditions <- 
  trainControl(method='cv', # K-fold cross validation
               summaryFunction = twoClassSummary, # classification problem
               classProbs = TRUE, # classification problem
               index = folds # The indices for our folds (so they are always the same)
  )


```

```{r}
## ------------------------------------- Models -------------------------------------##


#Logit Model
mod_logit <-
  train(SuperPAC_yes ~ .,train_data_processed, # Equation
        data=train_data_processed, # Training data 
        method = "glm", # logit function
        metric = "ROC", # area under the curve
        trControl = control_conditions
  )

mod_logit



#K-Nearest Neighbors Model

mod_knn <-
  train(SuperPAC_yes ~  .,train_data_processed, # Equation (outcome and everything else)
        data=train_data_processed, # Training data 
        method = "knn", # K-Nearest Neighbors Algorithm
        metric = "ROC", # area under the curve
        trControl = control_conditions
  )

plot(mod_knn)



#CART

mod_cart <-
  train(SuperPAC_yes ~  .,train_data_processed, # Equation (outcome and everything else)
        data=train_data_processed, # Training data 
        method = "rpart", # Classification Tree
        metric = "ROC", # area under the curve
        trControl = control_conditions
  )

plot(mod_cart)




#Random Forest

mod_rf <-
  train(SuperPAC_yes ~  .,train_data_processed, # Equation (outcome and everything else)
        data=train_data_processed, # Training data 
        method = "ranger", # random forest (ranger is much faster than rf)
        metric = "ROC", # area under the curve
        trControl = control_conditions
  )

plot(mod_rf)

```

```{r}
## ------------------------------------- Model Comparison  -------------------------------------##

mod_list <-
  list(
    knn1 = mod_knn,
    #knn2 = mod_knn2,
    cart1 = mod_cart,
    #cart2 = mod_cart2,
    rf = mod_rf,
  )

# Generate Plot to compare output. 
dotplot(resamples(mod_list))

```

```{r}
## ------------------------------------- Predictive Performance -------------------------------------##

pred <- predict(xxxxx,newdata = test_data_processed)
confusionMatrix(table(pred,test_data_processed$SuperPAC_yes))
```

# Results

- Give a detailed summary of your results.
– Present your results clearly and concisely.
– Please use visualizations and tables whenever possible.

# Discussion

- Speak on the “success” of your project (as defined in your proposal).
  - Did you achieve what you set out to do? If not why?
– What tools/methods did you consider but not use in the final analysis?
– How would you expand the analysis if given more time?





















